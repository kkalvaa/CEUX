!function(e){"use strict";e(function(){function t(e,t){var i=e.offset().left,o=e.offset().top,n=e.outerHeight(!0),l=e.outerWidth(!0),s=o+n,r=i+l,a=t.offset().left,c=t.offset().top,d=t.outerHeight(!0),h=t.outerWidth(!0),u=c+d,g=a+h;return c>s||o>u||a>r||i>g?!1:!0}var i=i||{};i.Data=Backbone.Model.extend({defaults:{title:"Your title here",permalink:"",content:{},meta:{}}}),e.get(ajaxurl,{action:"get_cb_button_tpl"}).done(function(e){i.blocksBtn_tpl=e,i.blockMenu=new i.BlocksContainerView({collection:i.blocksCol})}),i.Uploader=Backbone.Model.extend({initialize:function(){this.objects={browse_button:this.get("browse_button"),container:this.get("container"),drop_element:this.get("drop_element")},this.$settings=_.extend({},this.get("defaults"),this.objects),this.instance=new plupload.Uploader(this.$settings),this.init()},init:function(){var e=this,t=e.instance;setTimeout(function(){t.init(),t.bind("FilesAdded",_.bind(e.filesAdded,this)),t.bind("QueueChanged",_.bind(e.queueChanged,this)),t.trigger("DisableBrowse",!0)},10)},logIt:function(){console.log(this.instance)},filesAdded:function(e){console.log("FilesAdded"),e.start()},queueChanged:function(e){console.log("QueueChanged"),e.start(),e.refresh()}}),i.BlockModel=Backbone.Model.extend(),i.BlocksContainer=Backbone.Collection.extend({url:ajaxurl,model:i.BlockModel,group:function(e){return _(this.filter(function(t){return t.get("group")==e}))},search:function(e){if(""==e)return this;var t=new RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))}}),i.blocksCol=new i.BlocksContainer,i.BlockButton=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(i.blocksBtn_tpl),this.render()},render:function(){return this.$el.html(this.template({name:this.model.get("name"),slug:this.model.get("slug"),icon:this.model.get("icon"),view:this.model.get("view")})),this}}),i.BlocksContainerView=Backbone.View.extend({el:"#blocksSelect",events:{"keyup #blocks-search":"search","click .customBlock":"addBlock"},initialize:function(){_.bindAll(this,"render"),this.listenTo(this.collection,"reset",this.render),this.defaults=e("#defaults-container"),this.others=e("#others-container"),this.results=e("#results-container");var t={action:"get_content_blocks"},i=this;this.collection.fetch({data:e.param(t),success:function(){i.defaultBlocks=i.collection.group("default"),i.otherBlocks=i.collection.group("other"),i.render()},error:function(e,t){console.log(" Service request failure: "+e),console.log(t.responseText)}})},render:function(){var e=this;e.defaults.html("").append("<h3>Default Blocks</h3>"),e.others.html("").append("<h3>Other Blocks</h3>"),e.defaultBlocks.each(function(t){var o=new i.BlockButton({model:t});e.defaults.append(o.render().el)}),e.otherBlocks.each(function(t){var o=new i.BlockButton({model:t});e.others.append(o.render().el)})},renderList:function(e){this.defaults.html(""),this.others.html(""),this.results.html("");var t=this;e.each(function(e){var o=new i.BlockButton({model:e,collection:t.collection});t.results.append(o.render().el)})},search:function(t){var i=e(t.target).val();i?this.renderList(this.collection.search(i)):(this.results.html(""),this.render())},addBlock:function(t){var o=this.collection.findWhere({slug:e(t.currentTarget).attr("data-type")}),n=o.get("slug"),l=o.get("view");i.view.addBlock(n,l)}}),i.Block=Backbone.Model.extend({defaults:{wp_id:0,remove:!0,move:!0}}),i.Blocks=Backbone.Collection.extend({model:i.Block}),i.blocks=new i.Blocks,i.BlockView=Backbone.View.extend({tagName:"div",className:"content-block",tpl:"#wp-text",isEditable:!1,events:{"click .remove":"destroy","click .move-up":"moveUp","click .move-down":"moveDown"},init:function(){},onRender:function(){},initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e(this.tpl).html()),this.events&&(this.events=_.defaults(this.events,i.BlockView.prototype.events)),this.delegateEvents(this.events),this.init(),this.render(),this.onRender(),this.trigger("onRender")},render:function(){return this.$el.html(this.template({wp_id:this.model.get("wp_id"),block_type:this.model.get("type"),block_content:this.model.get("body"),remove:this.model.get("remove"),move:this.model.get("move"),editable:this.isEditable})),this},unrender:function(){this.$el.remove()},destroy:function(){this.model.destroy()},moveUp:function(t){var i=e(t.currentTarget).parents(".content-block"),o=i.prev(".content-block");o.insertAfter(i)},moveDown:function(t){var i=e(t.currentTarget).parents(".content-block"),o=i.next(".content-block");o.insertBefore(i)}}),i.textView=i.BlockView.extend({tpl:"#wp-text",isEditable:!0}),i.quoteView=i.BlockView.extend({tpl:"#wp-quote"}),i.codeView=i.BlockView.extend({tpl:"#wp-code",isEditable:!0,init:function(){console.log(this.model)}}),i.embedView=i.BlockView.extend({tpl:"#wp-embed"}),i.tweetView=i.BlockView.extend({tpl:"#wp-tweet"}),i.imgView=i.BlockView.extend({tpl:"#wp-image",events:{"click .open-modal":"mediaModal","click .remove-img":"removeImg","click .opt-size":"imgSize","click .opt-align":"imgAlign","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){"wp-image"==this.model.get("type")&&(this.imgSizes={})},onRender:function(){console.log("Plupload");var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-img-ui-"+e,drop_element:"wp-drag-drop-"+e,defaults:ceux_plupload})},mediaModal:function(t){t.preventDefault();var i=this;this.blockType=this.model.get("type");i.$el.find(e("."+this.blockType));"undefined"!=typeof o&&o.close();var o=wp.media.frames.customHeader=wp.media({title:"Select An Image",library:{type:"image"},button:{text:"insert image"},multiple:!1});"wp-image"==this.blockType&&o.on("select",function(){var e=o.state().get("selection").first().toJSON();e.getURL=function(t){for(var o in e.sizes)e.sizes.hasOwnProperty(o)&&(i.imgSizes[o]=e.sizes[o].url);return i.imgSizes[t]},console.log(this.atributes.toJSON())}),o.open()},imgSize:function(t){var i=e(t.currentTarget),o=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-size").removeClass("selected"),i.addClass("selected"),i.hasClass("size-thumbnail")?o.attr("src",this.imgSizes.thumbnail):i.hasClass("size-medium")?o.attr("src",this.imgSizes.medium):i.hasClass("size-full")&&o.attr("src",this.imgSizes.full))},imgAlign:function(t){var i=e(t.currentTarget),o=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-align").removeClass("selected"),i.addClass("selected"),i.hasClass("align-left")?o.attr("class","img-file alignleft"):i.hasClass("align-center")?o.attr("class","img-file aligncenter"):i.hasClass("align-right")?o.attr("class","img-file alignright"):o.attr("class","img-file alignone"))},removeImg:function(e){e.preventDefault(),this.render(),this.onRender()},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.View=Backbone.View.extend({el:"#content-blocks",events:{"click #add-block":"blockMenu","change #post-title":"updateTitle","click #publish":"savePost"},initialize:function(){this.container=e("#content"),this.addBtn=e("#blocksSelect"),this.counter=0,this.render(),this.$el.sortable({handle:".move",connectWith:".content-blocks",placeholder:"blocks-placeholder",start:function(t,i){i.placeholder.height(i.item.outerHeight()),e(".mce-tinymce").hide()}})},render:function(){},blockMenu:function(e){e.preventDefault(),this.addBtn.toggleClass("active")},addBlock:function(t,o){var n="wp-"+t;this.counter++;var l=new i.Block({wp_id:"block_"+this.counter,type:n}),s=i[o];this.collection.add(l),this.addBtn.removeClass("active");var r=new s({model:l});this.$el.append(r.render().el),r.isEditable&&this.setEditable(e("#"+l.get("wp_id")))},setEditable:function(e){var t=e.find(".editable").attr("id");tinymce.execCommand("mceAddEditor",!1,t)},savePost:function(){console.log(i.blocks.toJSON()),alert("Here we need to get all the data from post.Blocks collection, serialize it and save on the database. The post.Data model will hold the content when the post is loaded, then it should pass it to the post.Blocks collection to rebuild the content blocks.")}}),i.view=new i.View({collection:i.blocks}),tinymce.init({selector:".editable",add_unload_trigger:!1,schema:"html5",inline:!0,fixed_toolbar_container:"#wp-editor-toolbar",menubar:!1,toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",statusbar:!1}),e("#add-block").on("click",function(t){t.preventDefault(),e("#blocksSelect").toggleClass("active")}),e(window).scroll(function(){t(e("#postdivrich"),e("#wpadminbar"))?e("#wp-editor-toolbar").css({position:"fixed",top:32,zIndex:9999,width:e("#postdivrich").width()}):e("#wp-editor-toolbar").css({position:"static"})})})}(jQuery);